<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Add Movie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen p-6">
    <div class="max-w-2xl mx-auto bg-gray-800 p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-green-400">‚ûï Add New Movie</h1>

        <% if (!isAdmin) { %>
            <p class="text-red-500 text-center">Access Denied. Only admins can add movies.</p>
            <% } else { %>
                <!-- Debug info (remove in production) -->
                <div id="debug-info" class="mb-4 p-3 bg-blue-900 rounded hidden">
                    <h3 class="text-blue-400 font-bold">Form Data Preview:</h3>
                    <pre id="form-preview" class="text-sm mt-2"></pre>
                </div>

                <form id="movieForm" action="/admin/add?admin=8892" method="POST" class="grid gap-4">
                    <input type="text" name="title" placeholder="Title" required class="p-3 rounded bg-gray-700" />
                    <textarea name="description" placeholder="Description" rows="4" required class="p-3 rounded bg-gray-700"></textarea>
                    <input type="text" name="cast" placeholder="Cast (comma-separated)" required class="p-3 rounded bg-gray-700" />
                    <input type="text" name="genre" placeholder="Genre (comma-separated)" required class="p-3 rounded bg-gray-700" />
                    <input type="text" name="movieLanguage" placeholder="Language" required class="p-3 rounded bg-gray-700" />
                    <input type="text" name="quality" placeholder="Quality (comma-separated)" required class="p-3 rounded bg-gray-700" />
                    <input type="url" name="poster" placeholder="Poster URL" required class="p-3 rounded bg-gray-700" />

                    <!-- Screenshot inputs (minimum 3 required) -->
                    <div>
                        <label class="block mb-2 font-semibold text-green-400">Screenshots (Minimum 3 Required)</label>
                        <input type="url" name="screenshot1" class="screenshot-input block w-full p-2 mb-2 bg-gray-700 rounded" placeholder="Screenshot 1 URL" required>
                        <input type="url" name="screenshot2" class="screenshot-input block w-full p-2 mb-2 bg-gray-700 rounded" placeholder="Screenshot 2 URL" required>
                        <input type="url" name="screenshot3" class="screenshot-input block w-full p-2 mb-2 bg-gray-700 rounded" placeholder="Screenshot 3 URL" required>
                        <input type="url" name="screenshot4" class="screenshot-input block w-full p-2 mb-2 bg-gray-700 rounded" placeholder="Screenshot 4 URL (Optional)">
                        <input type="url" name="screenshot5" class="screenshot-input block w-full p-2 mb-2 bg-gray-700 rounded" placeholder="Screenshot 5 URL (Optional)">
                    </div>

                    <!-- Quality links with individual names -->
                    <div>
                        <label class="block mb-2 font-semibold text-green-400">Download Links by Quality</label>
                        <input type="url" name="link480p" placeholder="480p Download Link" class="p-3 rounded bg-gray-700 mb-2" />
                        <input type="url" name="link720p" placeholder="720p Download Link" class="p-3 rounded bg-gray-700 mb-2" />
                        <input type="url" name="link1080p" placeholder="1080p Download Link" class="p-3 rounded bg-gray-700 mb-2" />
                        <input type="url" name="linkOther" placeholder="Other Quality Link" class="p-3 rounded bg-gray-700" />
                    </div>

                    <button type="button" onclick="toggleDebug()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">
                    üîç Preview Form Data
                </button>

                    <button type="submit" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold">
                    ‚ûï Add Movie
                </button>
                </form>

                <script>
                    function toggleDebug() {
                        const debugDiv = document.getElementById('debug-info');
                        const formPreview = document.getElementById('form-preview');
                        const form = document.getElementById('movieForm');

                        if (debugDiv.classList.contains('hidden')) {
                            const formData = new FormData(form);
                            const data = {};

                            for (let [key, value] of formData.entries()) {
                                data[key] = value;
                            }

                            formPreview.textContent = JSON.stringify(data, null, 2);
                            debugDiv.classList.remove('hidden');
                        } else {
                            debugDiv.classList.add('hidden');
                        }
                    }

                    // Enhanced form validation
                    document.getElementById("movieForm").addEventListener("submit", function(e) {
                        // Check required screenshot fields
                        const requiredScreenshots = ['screenshot1', 'screenshot2', 'screenshot3'];
                        const missingScreenshots = requiredScreenshots.filter(name => {
                            const input = document.querySelector(`input[name="${name}"]`);
                            return !input.value.trim();
                        });

                        if (missingScreenshots.length > 0) {
                            alert(`‚ùå Please fill in the first 3 screenshot URLs. Missing: ${missingScreenshots.join(', ')}`);
                            e.preventDefault();
                            return;
                        }

                        // Validate URL formats for screenshots
                        const allScreenshotInputs = document.querySelectorAll('.screenshot-input');
                        for (let input of allScreenshotInputs) {
                            if (input.value.trim() && !isValidURL(input.value.trim())) {
                                alert(`‚ùå Invalid URL format in ${input.placeholder}`);
                                e.preventDefault();
                                return;
                            }
                        }

                        // Show loading state
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        submitBtn.innerHTML = '‚è≥ Adding Movie...';
                        submitBtn.disabled = true;
                    });

                    function isValidURL(string) {
                        try {
                            new URL(string);
                            return true;
                        } catch (_) {
                            return false;
                        }
                    }

                    // Auto-save form data to prevent loss on refresh
                    const form = document.getElementById('movieForm');
                    const inputs = form.querySelectorAll('input, textarea');

                    inputs.forEach(input => {
                        // Load saved data
                        const saved = localStorage.getItem(`movieForm_${input.name}`);
                        if (saved && !input.value) {
                            input.value = saved;
                        }

                        // Save data on change
                        input.addEventListener('input', () => {
                            localStorage.setItem(`movieForm_${input.name}`, input.value);
                        });
                    });

                    // Clear saved data on successful submission
                    form.addEventListener('submit', () => {
                        setTimeout(() => {
                            inputs.forEach(input => {
                                localStorage.removeItem(`movieForm_${input.name}`);
                            });
                        }, 1000);
                    });
                </script>
                <% } %>
    </div>
</body>

</html>